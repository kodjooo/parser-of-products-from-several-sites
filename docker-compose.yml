services:
  parser:
    build: .
    image: products-agent
    restart: always
    env_file:
      - .env
    volumes:
      - ./config/sites:/app/config/sites
      - ./state:/var/app/state
      - ./assets/images:/app/assets/images
      - ./secrets:/secrets
      - ./logs:/var/log/parser
    dns:
      - 8.8.8.8
      - 1.1.1.1
    command: ["python", "-m", "app.main", "run"]

  watchdog:
    build:
      context: .
      dockerfile: Dockerfile.watchdog
    restart: always
    depends_on:
      - parser
    volumes:
      - .:/workspace
      - ./logs:/var/log/parser
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    entrypoint:
      [
        "python3",
        "scripts/cooldown_watchdog.py",
        "--log-file",
        "/var/log/parser/parser.log",
        "--project-dir",
        "/workspace",
        "--service",
        "parser",
        "--restart-mode",
        "stack",
        "--buildkit",
        "off",
        "--build",
        "on",
        "--command-timeout",
        "1800",
        "--retry-attempts",
        "0",
        "--retry-delay-seconds",
        "300",
        "--log-output",
        "/var/log/parser/watchdog.log",
      ]
