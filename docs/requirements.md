ТЗ: ИИ-АГЕНТ ДЛЯ СБОРА ССЫЛОК ТОВАРОВ ИЗ КАТЕГОРИЙ САЙТОВ → GOOGLE SHEETS (1 САЙТ = 1 ВКЛАДКА)

1) Цель  
Собрать все ссылки на карточки товаров из заданных категорий интернет-магазинов и записать их в Google Таблицу. Для каждого сайта — отдельная вкладка. Агент должен уметь проходить пагинацию (включая “Показать ещё”/бесконечную прокрутку), устойчиво работать к временным ошибкам и уметь продолжать с места остановки.

2) Входные данные  
2.1. Общая конфигурация запуска (JSON/YAML) — путь к Google Sheet, поведение повтора/лимиты, прокси и т. п.  
2.2. Пересайтовая конфигурация (один файл на сайт, см. схему ниже).  
2.3. Список категорий для каждого сайта (перечень URL) — указывается в конфигурации сайта в блоке category_urls.  
Примечание: генерацию структуры конфигурационных файлов ИИ выполняет один раз на этапе интеграции. Дальше используется только заполнение category_urls и при необходимости селекторов/правил.

3) Выходные данные (Google Sheets)  
Одна вкладка на сайт, имя вкладки = ДОМЕН_сайта (например, alcoplaza.ru).  
Столбцы (минимальный состав):  
- A: source_site (домен)  
- B: category (часть URL после `/items/`)  
- C: category_url (исходная категория)  
- D: product_url (абсолютная ссылка на товар)  
- E: product_content (очищенный текст)  
- F: discovered_at (ISO8601, UTC)  
- G: run_id (UUID запуска)  
- H: product_id_hash (md5 от product_url)  
- I: page_num  
- J: metadata (image_url и т.п.)  
- K: image_path (имя сохранённого файла в каталоге изображений)  
- L: name (en)  
- M: name (ru)  
- N: price (without discount)  
- O: price (with discount)  
- P: status (по умолчанию «Не обработано»)  
- Q: note (ошибка/причина, если есть)  
- R: processed_at  
- S: llm_raw  
Дополнительно допускаются другие служебные поля (depth, score, и т. п.).

4) Правила записи в таблицу  
— Идемпотентность: не записывать дубликаты product_url в пределах вкладки.  
— Если product_url уже существовал, добавить новую строку не нужно; при необходимости можно обновить discovered_at и run_id через апсерт (но по умолчанию — пропуск).  
— Пакетная запись: группировать по 100–500 строк на один запрос к API.  
— Ошибки/скипы писать с status=failed и текстом note.

5) Требования к обходу страницы категории  
— Агент открывает category_url, ждёт выполнения условий (см. wait_conditions), извлекает ссылки на товары по селектору product_link_selector.  
— Пагинация: поддержать 3 режима  
   a) numbered_pages: параметр в URL (?page=2) — увеличивать до конца.  
   b) next_button: клик по кнопке «Далее»/«Показать ещё» пока доступна.  
   c) infinite_scroll: скроллить до низа, ждать подгрузку, повторять до стабилизации.  
— Остановка:  
   • нет новых товаров за итерацию;  
   • достигнут лимит страниц/прокруток из конфигурации;  
   • сработало правило stop_conditions (например, исчез блок пагинации).  
— Все относительные ссылки нормализовать в абсолютные через base_url.  
— Исключать явные дубликаты на уровне текущего запуска (мультимножество фильтруется по URL).
— Для страниц товаров предусмотреть возможность обрезать текст после заданных блоков (например, отзывы). Список CSS-селекторов задаётся в конфиге сайта (`selectors.content_drop_after`); найденный блок и всё, что идёт после него, не попадает в `product_content`. Дополнительно нужен список `selectors.content_exclude_selectors` — элементы, подходящие этим селекторам, удаляются из разметки, но остальной текст сохраняется (удобно, когда внутри описания встречаются рекламные блоки). Помимо этого конфиг поддерживает селекторы для имён/цен (`name_en_selector`, `name_ru_selector`, `price_without_discount_selector`, `price_with_discount_selector`) и словарь `category_labels` для перевода slug → названия категории. Для `price_with_discount_selector` допускается передача списка селекторов — движок перебирает их по порядку и возвращает первое найденное значение.

6) Надёжность и антиблок  
— User-Agent ротация, опционально прокси-пул.  
— Случайные задержки между запросами (джиттер), настраиваемые паузы между страницами.  
— Повторы с экспоненциальной паузой для кодов 429/5xx (например, 3 попытки: 2с/5с/10с).  
— Лимиты: max_requests_per_minute, max_concurrency_per_site.  
— Робастность к “пустым” страницам: повторная загрузка до 2 раз.  
— По возможности уважать robots.txt; не собирать закрытые разделы/личные кабинеты.

7) Возобновляемость (resume)  
— Локальный state (SQLite/JSONL) + скрытая вкладка в Google Sheets “_state”:  
   • для каждой category_url хранить last_page, last_offset, last_product_count, last_run_ts;  
— При перезапуске агент читает state и продолжает.  
— Если структура сайта изменилась, можно сбросить state для конкретной категории или всего сайта.

8) Ограничения по времени и объёму  
— На категорию: max_pages, max_scrolls, max_products (конфигурируемые).  
— Глобально: stop_after_products, stop_after_minutes для всего запуска.  
— Ведение счётчиков для честного останова.

9) Валидация данных  
— URL должен быть абсолютным, со схемой http/https.  
— Фильтр: исключить “#”, “?add-to-cart”, параметры сортировки, явный трекинг (utm, gclid) по конфигу.  
— При необходимости нормализация: удаление известных трекинг-параметров (whitelist/blacklist параметров в конфиге).

10) Логи и мониторинг  
— Уровни: INFO (старт/стоп/счётчики), WARNING (пропуски), ERROR (фейлы).  
— Итоговый отчёт по сайту:  
   • категорий обработано;  
   • найдено уникальных ссылок;  
   • пропущено (дубликаты);  
   • ошибки по категориям.  
— Писать краткий итог в служебную вкладку “_runs” с полями: run_id, site, started_at, finished_at, total_found, total_written, total_failed.

11) Доступ к Google Sheets  
— OAuth 2.0, scope: spreadsheets.  
— Пакетная запись (batchUpdate / values.batchUpdate).  
— Обязательно: экспоненциальный бэкофф на 429/Quota exceeded.  
— Форматирование не требуется; важны только значения.

12) Стек и режимы рендеринга  
— HTTP-клиент + парсер HTML (requests + lxml/BeautifulSoup) для статичных страниц.  
— Headless-браузер (Playwright/Puppeteer) для сайтов с динамической подгрузкой, infinite scroll и кнопками “Показать ещё”.  
— Выбор режима указывается в конфигурации сайта (engine: http | browser).  
— headless-скролл: скроллить до низа, ждать network idle или появление новых карточек.

13) Конфигурация: общая (пример YAML)
sheet:
  spreadsheet_id: "GOOGLE_SHEET_ID"
  write_batch_size: 200
  sheet_state_tab: "_state"
  sheet_runs_tab: "_runs"

runtime:
  max_concurrency_per_site: 2
  global_stop:
    stop_after_products: 50000
    stop_after_minutes: 180

network:
  user_agents: ["…несколько строк…"]
  proxy_pool: []   # ["http://user:pass@host:port", ...] или пусто
  request_timeout_sec: 30
  retry:
    max_attempts: 3
    backoff_sec: [2, 5, 10]

dedupe:
  strip_params_blacklist: ["utm_*", "gclid", "yclid", "fbclid"]
