# План реализации

## Этап 1. Архитектура и окружение
Статус: выполнено
- Уточнить доменную модель, потоки данных и точки расширения в `docs/architecture.md`, зафиксировать используемые сервисы (Google Sheets, локальное хранилище state, прокси/браузерный движок).
- Спроектировать формат общей конфигурации (runtime/sheet/network/dedupe) и схемы конфигов сайтов; определить обязательные поля и значения по умолчанию.
- Подготовить `.env`/`.env.example` с описанием переменных (OAuth, прокси, фичи) и связать их с конфигурацией.
- Настроить базовую структуру проекта (CLI-точка входа, модули `config`, `sheets`, `crawler`, `state`, `logging`) и Docker-окружение, убедиться что запуск выполняется только через контейнер.

## Этап 2. Управление конфигурациями и состоянием
Статус: выполнено
- Реализовать загрузчик конфигураций (YAML/JSON), валидацию схемы и слияние глобальных и пересайтовых настроек; покрыть unit-тестами граничные случаи.
- Создать модуль persist/state: локальное хранилище (SQLite/JSONL) + служебная вкладка `_state` в Google Sheets, методы чтения/записи для category_url и run_id.
- Подготовить инструменты сброса/обновления state по категории и сайту, CLI-параметры для резюма и dry-run.

## Этап 3. Модуль обхода сайтов
Статус: выполнено
- Реализовать движок HTTP (requests+lxml) и браузерный движок (Playwright/Puppeteer) с общим интерфейсом, поддержать выбор `engine` в конфиге сайта.
- Добавить обработку трёх режимов пагинации (numbered_pages, next_button, infinite_scroll), параметризовать лимиты max_pages/max_scrolls/max_products.
- Внедрить нормализацию ссылок (base_url, абсолютные URL), фильтрацию и дедупликацию в рамках запуска.
- Реализовать обработку wait_conditions/stop_conditions, таймауты загрузки и повторные загрузки пустых страниц.

## Этап 4. Запись в Google Sheets и дедуп
Статус: выполнено
- Имплементировать клиент Google Sheets (OAuth2, batchUpdate) с экспоненциальным бэкоффом на 429/5xx и настройкой размера батчей.
- Добавить модель данных для строк (source_site, category, category_url, product_url, discovered_at, run_id, status, note, расширения) и правила идемпотентности (проверка существования URL во вкладке, md5-хэш).
- Обеспечить пакетную запись 100–500 строк, логирование успешных/пропущенных ссылок и запись ошибок со статусом `failed`.
- Заполнять служебную вкладку `_runs`, синхронизировать счётчики с глобальными ограничениями (stop_after_products/minutes).

## Этап 5. Надёжность, мониторинг и тесты
Статус: выполнено
- Добавить антиблок-механизмы: ротация User-Agent, опциональный прокси-пул, джиттер задержек, повторные запросы с экспоненциальной паузой.
- Реализовать систему логирования (INFO/WARNING/ERROR) и итоговые отчёты по сайту (сводка уникальных/дубликатов/ошибок).
- Покрыть ключевые модули тестами (`tests/`): парсинг конфигов, дедуп, пагинацию, резюмируемость, интеграцию с Sheets (моки).
- Обновить `README.md` (инструкции по развёртыванию, OAuth, запуск в Docker, поддержка планов возобновления), проверить необходимость правок в связанных документах и отметить прогресс в `docs/plan.md` (проставлять `выполнено` после завершения каждого этапа).
