# План реализации

## Этап 1. Архитектура и окружение
Статус: выполнено
- Уточнить доменную модель, потоки данных и точки расширения в `docs/architecture.md`, зафиксировать используемые сервисы (Google Sheets, локальное хранилище state, прокси/браузерный движок).
- Спроектировать формат общей конфигурации (runtime/sheet/network/dedupe) и схемы конфигов сайтов; определить обязательные поля и значения по умолчанию.
- Подготовить `.env`/`.env.example` с описанием переменных (OAuth, прокси, фичи) и связать их с конфигурацией.
- Настроить базовую структуру проекта (CLI-точка входа, модули `config`, `sheets`, `crawler`, `state`, `logging`) и Docker-окружение, убедиться что запуск выполняется только через контейнер.

## Этап 2. Управление конфигурациями и состоянием
Статус: выполнено
- Реализовать загрузчик конфигураций (YAML/JSON), валидацию схемы и слияние глобальных и пересайтовых настроек; покрыть unit-тестами граничные случаи.
- Создать модуль persist/state: локальное хранилище (SQLite/JSONL) + служебная вкладка `_state` в Google Sheets, методы чтения/записи для category_url и run_id.
- Подготовить инструменты сброса/обновления state по категории и сайту, CLI-параметры для резюма и dry-run.

## Этап 3. Модуль обхода сайтов
Статус: выполнено
- Реализовать движок HTTP (requests+lxml) и браузерный движок (Playwright/Puppeteer) с общим интерфейсом, поддержать выбор `engine` в конфиге сайта.
- Добавить обработку трёх режимов пагинации (numbered_pages, next_button, infinite_scroll), параметризовать лимиты max_pages/max_scrolls/max_products.
- Внедрить нормализацию ссылок (base_url, абсолютные URL), фильтрацию и дедупликацию в рамках запуска.
- Реализовать обработку wait_conditions/stop_conditions, таймауты загрузки и повторные загрузки пустых страниц.

## Этап 4. Запись в Google Sheets и дедуп
Статус: выполнено
- Имплементировать клиент Google Sheets (OAuth2, batchUpdate) с экспоненциальным бэкоффом на 429/5xx и настройкой размера батчей.
- Добавить модель данных для строк (source_site, category, category_url, product_url, discovered_at, run_id, status, note, расширения) и правила идемпотентности (проверка существования URL во вкладке, md5-хэш).
- Обеспечить пакетную запись 100–500 строк, логирование успешных/пропущенных ссылок и запись ошибок со статусом `failed`.
- Заполнять служебную вкладку `_runs`, синхронизировать счётчики с глобальными ограничениями (stop_after_products/minutes).

## Этап 5. Надёжность, мониторинг и тесты
Статус: выполнено
- Добавить антиблок-механизмы: ротация User-Agent, опциональный прокси-пул, джиттер задержек, повторные запросы с экспоненциальной паузой.
- Реализовать систему логирования (INFO/WARNING/ERROR) и итоговые отчёты по сайту (сводка уникальных/дубликатов/ошибок).
- Покрыть ключевые модули тестами (`tests/`): парсинг конфигов, дедуп, пагинацию, резюмируемость, интеграцию с Sheets (моки).
- Обновить `README.md` (инструкции по развёртыванию, OAuth, запуск в Docker, поддержка планов возобновления), проверить необходимость правок в связанных документах и отметить прогресс в `docs/plan.md` (проставлять `выполнено` после завершения каждого этапа).

## Этап 6. Поведенческий слой для Playwright
Статус: выполнено
- Проанализировать текущую архитектуру (`docs/architecture.md`) и расширить её описанием «человеческого» слоя: прокрутки, перемещения курсора, дополнительные переходы, конфигурационные флаги и взаимосвязь с движком Playwright (не изменяя основную бизнес-логику обхода).
- Расширить схему конфигураций/`.env`: диапазоны задержек, вероятности скролла/пропуска, лимиты дополнительных действий, селекторы для hover, управление контекстами и заголовками; зафиксировать переменные в `.env.example`/`.env` с комментариями о получении доступа.
- Реализовать модуль поведенческих паттернов, который оборачивает основные действия браузерного движка: случайные паузы, скроллы (с диапазонами глубины), перемещения курсора, hover по заданным селекторам, возвраты/back и дополнительные переходы на запасные карточки/категории; настроить логирование каждого дополнительного действия, прокси/контекста и времени нахождения на странице.
- Обновить управление Playwright-контекстами для поддержки отдельных сессий на прокси (User-Agent/Accept-Language/cookies из конфигов) и сохранения storage state.
- Добавить режим отладки (флаг CLI/конфига), который включает подробные логи поведенческого слоя и отмечает «дополнительные» карточки; учесть взаимодействие с существующим throttling и retry.
- Дополнить тесты (`tests/`) для конфигурации поведенческого слоя, корректного применения задержек, скроллов и логирования; при необходимости замокать браузерный движок и обновить README.md с инструкциями по настройке нового функционала.

## Этап 7. Локальные файлы логов
Статус: выполнено
- Добавить переменную окружения `LOG_FILE_PATH`, чтобы агент писал копию логов в файл, доступный как в контейнере, так и на хосте.
- Расширить `app.logger` файловым обработчиком, обновить Docker volumes (`./logs:/var/log/parser`) и описать настройки в `.env`, `.env.example`, документации.
- Обновить README (инструкции по запуску и чтению `logs/parser.log`) и тесты, подтверждающие создание лог-файла.

## Этап 8. Контроль проблемных прокси
Статус: выполнено
- Реализовать подсчёт повторных ответов HTTP 403 по каждому прокси/прямому IP, фиксировать такие случаи в файле `NETWORK_BAD_PROXY_LOG_PATH` и исключать источник из пула.
- Добавить переменную окружения для пути к файлу, обновить `.env`, `.env.example`, Docker Compose (volume `./logs`), а также документацию (`README`, `docs/architecture.md`).
- Расширить `ProxyPool`, HTTP/Playwright-движки, загрузчик карточек и `ImageSaver`, чтобы метить испорченные источники и покрыть поведение тестами.

## Этап 9. Автооживление прокси
Статус: выполнено
- Добавить таймер автоматического восстановления прокси (переменная `NETWORK_PROXY_REVIVE_AFTER_MINUTES`), чтобы источники возвращались в пул без рестарта.
- Снимать блокировку сразу после успешной загрузки страницы, чтобы единичные сбои не «сжигали» весь пул.
- Обновить `ProxyPool`, движки, `.env`, документацию и тесты, чтобы зафиксировать новое поведение.

## Этап 10. Антиблокировочные паузы и локальные конфиги
Статус: выполнено
- Добавить глобальные счётчики подряд неудачных загрузок категорий/карточек и настраиваемый cooldown (порог + длительность) для SiteCrawler и ProductContentFetcher, чтобы пережидать временные лимиты магазинов.
- Пробросить параметры через `.env`/`.env.example`/`conf-another-version`, описать их в документации (`README.md`, `docs/architecture.md`, `docs/requirements.md`) и объяснить сценарий из логов (часовые блокировки Winestyle).
- Зафиксировать правила хранения локальных конфигов сайтов (`config/sites`) в README, удалить `config/sites/winestyle-7.yml` из репозитория и добавить явный ignore-запись, чтобы конфиги оставались только на рабочей машине.
